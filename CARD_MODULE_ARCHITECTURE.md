# ğŸ¨ é£ä¹¦å¡ç‰‡æ¨¡å—æ¶æ„æ€»ç»“

**æ–‡æ¡£ç‰ˆæœ¬**: 3.0.0
**æœ€åæ›´æ–°**: 2025-01-03
**é€‚ç”¨ç‰ˆæœ¬**: Project_Feishu_Bot v3.x

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æ€»ç»“é£ä¹¦å¡ç‰‡æ¨¡å—çš„å®Œæ•´æ¶æ„å®ç°ï¼ŒåŸºäºé…ç½®é©±åŠ¨çš„è®¾è®¡ç†å¿µï¼Œå®ç°äº†é«˜åº¦æ¨¡å—åŒ–ã€å¯æ‰©å±•çš„å¡ç‰‡ç®¡ç†ç³»ç»Ÿã€‚

## ğŸ—ï¸ æ¶æ„æ¼”è¿›å†ç¨‹

### ç¬¬ä¸€ä»£: ç¡¬ç¼–ç å®ç°
- å¡ç‰‡é€»è¾‘åˆ†æ•£åœ¨å„å¤„
- ä¿®æ”¹éœ€è¦æ”¹åŠ¨å¤šä¸ªæ–‡ä»¶
- æ‰©å±•æ€§å·®ï¼Œç»´æŠ¤å›°éš¾

### ç¬¬äºŒä»£: æ¨¡æ¿åŒ–æ”¹è¿›
- å¼•å…¥å¡ç‰‡ç®¡ç†å™¨æ¦‚å¿µ
- ç»Ÿä¸€æ¨¡æ¿å¤„ç†
- ä»éœ€æ‰‹åŠ¨æ³¨å†Œç®¡ç†å™¨

### ç¬¬ä¸‰ä»£: é…ç½®é©±åŠ¨æ¶æ„ (å½“å‰)
- å®Œå…¨é…ç½®åŒ–çš„å¡ç‰‡ç®¡ç†
- è‡ªåŠ¨å‘ç°å’Œæ³¨å†Œæœºåˆ¶
- é›¶ä¿®æ”¹æ‰©å±•æ–°å¡ç‰‡ç±»å‹

## ğŸ¯ æ ¸å¿ƒè®¾è®¡ç†å¿µ

### 1. é…ç½®é©±åŠ¨ (Configuration-Driven)
- æ‰€æœ‰å¡ç‰‡é…ç½®é›†ä¸­åœ¨ `cards_business_mapping.json`
- è¿è¡Œæ—¶åŠ¨æ€åŠ è½½å’Œè§£æé…ç½®
- ä¸šåŠ¡é€»è¾‘ä¸é…ç½®å®Œå…¨åˆ†ç¦»

### 2. æ’ä»¶åŒ–æ¶æ„ (Plugin Architecture)
- æ¯ä¸ªå¡ç‰‡ç®¡ç†å™¨éƒ½æ˜¯ç‹¬ç«‹æ’ä»¶
- æ”¯æŒçƒ­æ’æ‹”ï¼Œä¸å½±å“å…¶ä»–æ¨¡å—
- ç»Ÿä¸€çš„æ’ä»¶æ¥å£æ ‡å‡†

### 3. è´£ä»»åˆ†ç¦» (Separation of Concerns)
```
â”œâ”€â”€ é…ç½®å±‚: cards_business_mapping.json
â”œâ”€â”€ æœåŠ¡å±‚: CardBusinessMappingService
â”œâ”€â”€ ç®¡ç†å±‚: BaseCardManager + å…·ä½“å®ç°
â”œâ”€â”€ æ³¨å†Œå±‚: FeishuCardRegistry
â”œâ”€â”€ å¤„ç†å±‚: CardHandler
â””â”€â”€ ä¸šåŠ¡å±‚: å„ç§Processor
```

## ğŸ”§ æŠ€æœ¯æ¶æ„è¯¦è§£

### æ ¸å¿ƒç»„ä»¶å…³ç³»å›¾

```mermaid
graph TB
    Config[cards_business_mapping.json] --> |é…ç½®é©±åŠ¨| MappingService[CardBusinessMappingService]
    MappingService --> |æä¾›é…ç½®| Registry[FeishuCardRegistry]

    BaseManager[BaseCardManager] --> |ç»§æ‰¿| BiliManager[BilibiliCardManager]
    BaseManager --> |ç»§æ‰¿| UserManager[UserUpdateCardManager]
    BaseManager --> |ç»§æ‰¿| AdsManager[AdsUpdateCardManager]

    BiliManager --> |æ³¨å†Œåˆ°| Registry
    UserManager --> |æ³¨å†Œåˆ°| Registry
    AdsManager --> |æ³¨å†Œåˆ°| Registry

    Registry --> |ä½¿ç”¨| CardHandler[CardHandler]
    CardHandler --> |é›†æˆ| MessageProcessor[MessageProcessor]

    MessageProcessor --> |è°ƒç”¨| BiliProcessor[BilibiliProcessor]
    MessageProcessor --> |è°ƒç”¨| AdminProcessor[AdminProcessor]
```

### æ•°æ®æµå‘

```
ç”¨æˆ·ç‚¹å‡»å¡ç‰‡
    â†“
é£ä¹¦å›è°ƒäº‹ä»¶
    â†“
CardHandler.handle_feishu_card()
    â†“
è½¬æ¢ä¸ºMessageContext
    â†“
MessageProcessor.process_message()
    â†“
è·¯ç”±åˆ°å…·ä½“ä¸šåŠ¡å¤„ç†å™¨
    â†“
è¿”å›ProcessResult
    â†“
æ ¹æ®response_typeåˆ†å‘å¤„ç†
    â†“
ç”Ÿæˆé£ä¹¦å“åº”/å‘é€æ–°æ¶ˆæ¯
```

## ğŸ“ æ–‡ä»¶ç»„ç»‡ç»“æ„

```
Module/
â”œâ”€â”€ Adapters/feishu/cards/
â”‚   â”œâ”€â”€ __init__.py                 # å¡ç‰‡æ¨¡å—åˆå§‹åŒ–å’Œè‡ªåŠ¨æ³¨å†Œ
â”‚   â”œâ”€â”€ card_registry.py           # åŸºç¡€ç®¡ç†å™¨å’Œæ³¨å†Œè¡¨
â”‚   â”œâ”€â”€ bilibili_cards.py          # Bç«™å¡ç‰‡ç®¡ç†å™¨
â”‚   â”œâ”€â”€ user_update_cards.py       # ç”¨æˆ·æ›´æ–°å¡ç‰‡ç®¡ç†å™¨
â”‚   â””â”€â”€ ads_update_cards.py        # å¹¿å‘Šæ›´æ–°å¡ç‰‡ç®¡ç†å™¨
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ card_business_mapping_service.py  # é…ç½®æ˜ å°„æœåŠ¡
â”‚   â””â”€â”€ router/card_builder.py     # AIè·¯ç”±å¡ç‰‡æ„å»ºå™¨
â””â”€â”€ Business/processors/
    â”œâ”€â”€ bilibili_processor.py      # Bç«™ä¸šåŠ¡å¤„ç†å™¨
    â””â”€â”€ admin_processor.py         # ç®¡ç†å‘˜ä¸šåŠ¡å¤„ç†å™¨

cards_business_mapping.json        # æ ¸å¿ƒé…ç½®æ–‡ä»¶
```

## âš™ï¸ é…ç½®æ–‡ä»¶è§„èŒƒ

### business_mappings ç»“æ„
```json
{
  "ä¸šåŠ¡æ ‡è¯†": {
    "response_type": "å“åº”ç±»å‹æ ‡è¯†",
    "card_config_key": "å…³è”çš„å¡ç‰‡é…ç½®é”®",
    "processor": "ä¸šåŠ¡å¤„ç†å™¨åç§°",
    "timeout_seconds": 30,
    "description": "ä¸šåŠ¡æè¿°"
  }
}
```

### card_configs ç»“æ„
```json
{
  "å¡ç‰‡é…ç½®é”®": {
    "reply_modes": "å›å¤æ¨¡å¼(new/reply/thread)",
    "class_name": "ç®¡ç†å™¨ç±»å",
    "module_path": "å®Œæ•´æ¨¡å—è·¯å¾„",
    "template_id": "é£ä¹¦æ¨¡æ¿ID",
    "template_version": "æ¨¡æ¿ç‰ˆæœ¬å·"
  }
}
```

## ğŸ­ å¡ç‰‡ç±»å‹å®ç°åˆ†æ

### 1. Bç«™è§†é¢‘å¡ç‰‡
**æ–‡ä»¶**: `bilibili_cards.py`
**ä¸šåŠ¡ID**: `bili_video_menu`
**ç‰¹è‰²åŠŸèƒ½**:
- ä¸»è§†é¢‘+é™„åŠ è§†é¢‘åˆ—è¡¨å±•ç¤º
- å·²è¯»çŠ¶æ€å®æ—¶æ›´æ–°
- Android/Webé“¾æ¥é€‚é…

**æ¨¡æ¿å‚æ•°ç»“æ„**:
```json
{
  "main_title": "ä¸»è§†é¢‘æ ‡é¢˜",
  "main_priority": "ä¼˜å…ˆçº§",
  "main_duration_str": "æ—¶é•¿",
  "main_author": "ä½œè€…",
  "main_source": "æ¥æº",
  "main_upload_date_str": "ä¸Šä¼ æ—¥æœŸ",
  "main_summary": "æ‘˜è¦",
  "main_url": "ç½‘é¡µé“¾æ¥",
  "main_android_url": "å®‰å“é“¾æ¥",
  "main_is_read_str": "å·²è¯»çŠ¶æ€æ–‡æœ¬",
  "main_is_read": "å·²è¯»çŠ¶æ€å¸ƒå°”å€¼",
  "action_info": "æ“ä½œä¿¡æ¯",
  "addtional_videos": ["é™„åŠ è§†é¢‘åˆ—è¡¨"]
}
```

### 2. ç”¨æˆ·æ›´æ–°å¡ç‰‡
**æ–‡ä»¶**: `user_update_cards.py`
**ä¸šåŠ¡ID**: `update_user`
**ç‰¹è‰²åŠŸèƒ½**:
- äº¤äº’å¼ç”¨æˆ·ç±»å‹é€‰æ‹©
- å®æ—¶çŠ¶æ€æ›´æ–°
- æ“ä½œç¡®è®¤æœºåˆ¶

**äº¤äº’ç»„ä»¶**:
- `confirm_action`: ç¡®è®¤æ“ä½œ
- `cancel_action`: å–æ¶ˆæ“ä½œ
- `user_type_selector`: ç”¨æˆ·ç±»å‹é€‰æ‹©å™¨

### 3. å¹¿å‘Šæ—¶é—´æ›´æ–°å¡ç‰‡
**æ–‡ä»¶**: `ads_update_cards.py`
**ä¸šåŠ¡ID**: `update_ads`
**ç‰¹è‰²åŠŸèƒ½**:
- æ—¶é—´ç¼–è¾‘å™¨ç»„ä»¶
- æ‰¹é‡æ—¶é—´æˆ³æ›´æ–°
- ç®¡ç†å‘˜æƒé™æ§åˆ¶

## ğŸ” å…³é”®æŠ€æœ¯ç‰¹æ€§

### 1. è£…é¥°å™¨å®‰å…¨ä½“ç³»
```python
@card_build_safe("é”™è¯¯æ¶ˆæ¯")          # å¡ç‰‡æ„å»ºå®‰å…¨
@card_operation_safe("é”™è¯¯æ¶ˆæ¯")      # å¡ç‰‡æ“ä½œå®‰å…¨
@message_conversion_safe("é”™è¯¯æ¶ˆæ¯")  # æ¶ˆæ¯è½¬æ¢å®‰å…¨
```

### 2. å¸¸é‡ç»Ÿä¸€ç®¡ç†
- `CardActions`: å¡ç‰‡åŠ¨ä½œç±»å‹
- `ResponseTypes`: å“åº”ç±»å‹
- `CardConfigKeys`: é…ç½®é”®å
- `UIElements`: UIå…ƒç´ ç±»å‹

### 3. è‡ªåŠ¨æ³¨å†Œæœºåˆ¶
```python
def initialize_card_managers(app_controller=None):
    """é…ç½®é©±åŠ¨çš„è‡ªåŠ¨æ³¨å†Œ"""
    # ä»é…ç½®æ–‡ä»¶è·å–æ‰€æœ‰ç®¡ç†å™¨å®šä¹‰
    card_definitions = card_mapping_service.get_all_definition()

    # åŠ¨æ€å¯¼å…¥å’Œæ³¨å†Œ
    for card_type, definition in card_definitions.items():
        module = __import__(definition['module_path'], fromlist=[definition['class_name']])
        manager_class = getattr(module, definition['class_name'])
        manager_instance = manager_class(app_controller=app_controller)
        card_registry.register_manager(card_type, manager_instance)
```

### 4. é…ç½®éªŒè¯æœºåˆ¶
- å¯åŠ¨æ—¶éªŒè¯é…ç½®æ–‡ä»¶å®Œæ•´æ€§
- æ¨¡æ¿IDå’Œç‰ˆæœ¬æ£€æŸ¥
- ç®¡ç†å™¨æ³¨å†ŒçŠ¶æ€ç›‘æ§

## ğŸ“Š æ€§èƒ½ä¸ç›‘æ§

### æ€§èƒ½ç‰¹æ€§
- **é…ç½®ç¼“å­˜**: é…ç½®æ–‡ä»¶ä¸€æ¬¡åŠ è½½ï¼Œå†…å­˜ç¼“å­˜
- **å»¶è¿ŸåŠ è½½**: ç®¡ç†å™¨æŒ‰éœ€å®ä¾‹åŒ–
- **å•ä¾‹æ¨¡å¼**: æ³¨å†Œè¡¨å…¨å±€å”¯ä¸€å®ä¾‹

### ç›‘æ§ä½“ç³»
- **æ—¥å¿—è¿½è¸ª**: å®Œæ•´çš„æ“ä½œæ—¥å¿—é“¾
- **é”™è¯¯ä¸ŠæŠ¥**: ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œä¸ŠæŠ¥
- **çŠ¶æ€æ£€æŸ¥**: å¡ç‰‡æ“ä½œçŠ¶æ€å®æ—¶ç›‘æ§

## ğŸš€ æ‰©å±•èƒ½åŠ›

### é›¶ä»£ç æ‰©å±•
ä»…éœ€ä¿®æ”¹é…ç½®æ–‡ä»¶å³å¯:
1. æ·»åŠ æ–°çš„ä¸šåŠ¡æ˜ å°„
2. å®šä¹‰å¡ç‰‡é…ç½®
3. ç³»ç»Ÿè‡ªåŠ¨å‘ç°å’ŒåŠ è½½

### çƒ­æ’æ‹”æ”¯æŒ
- è¿è¡Œæ—¶åŠ¨æ€æ³¨å†Œæ–°ç®¡ç†å™¨
- ç§»é™¤ä¸å½±å“ç°æœ‰åŠŸèƒ½
- å®Œå…¨å‘åå…¼å®¹

## ğŸ¯ æœ€ä½³å®è·µæ€»ç»“

### å¼€å‘è§„èŒƒ
1. **ç»§æ‰¿BaseCardManager**: æ‰€æœ‰ç®¡ç†å™¨å¿…é¡»ç»§æ‰¿åŸºç±»
2. **å®ç°å¿…è¦æ–¹æ³•**: `get_card_type_name()`, `get_supported_actions()`, `build_card()`
3. **ä½¿ç”¨è£…é¥°å™¨**: ä¿è¯å¼‚å¸¸å®‰å…¨
4. **é…ç½®ä¼˜å…ˆ**: é¿å…ç¡¬ç¼–ç 

### å‘½åè§„èŒƒ
- æ–‡ä»¶å: `{business}_cards.py`
- ç±»å: `{Business}CardManager`
- é…ç½®é”®: å°å†™ä¸‹åˆ’çº¿åˆ†éš”

### æµ‹è¯•ç­–ç•¥
- å•å…ƒæµ‹è¯•: æ¯ä¸ªç®¡ç†å™¨ç‹¬ç«‹æµ‹è¯•
- é›†æˆæµ‹è¯•: ç«¯åˆ°ç«¯å¡ç‰‡æµç¨‹æµ‹è¯•
- é…ç½®æµ‹è¯•: é…ç½®æ–‡ä»¶æ ¼å¼éªŒè¯

## ğŸ”® æœªæ¥æ¼”è¿›æ–¹å‘

### 1. æ¨¡æ¿ç®¡ç†å¢å¼º
- æ¨¡æ¿ç‰ˆæœ¬è‡ªåŠ¨è¿ç§»
- æ¨¡æ¿A/Bæµ‹è¯•æ”¯æŒ
- å¯è§†åŒ–æ¨¡æ¿ç¼–è¾‘å™¨

### 2. æ€§èƒ½ä¼˜åŒ–
- å¡ç‰‡æ¸²æŸ“ç¼“å­˜
- å¼‚æ­¥å¡ç‰‡åŠ è½½
- æ‰¹é‡æ“ä½œä¼˜åŒ–

### 3. ç›‘æ§å‘Šè­¦
- å¡ç‰‡ä½¿ç”¨ç»Ÿè®¡
- æ€§èƒ½æŒ‡æ ‡ç›‘æ§
- å¼‚å¸¸å‘Šè­¦æœºåˆ¶

### 4. æ™ºèƒ½åŒ–å‡çº§
- AIé©±åŠ¨çš„å¡ç‰‡æ¨è
- ç”¨æˆ·è¡Œä¸ºåˆ†æ
- ä¸ªæ€§åŒ–å¡ç‰‡ä½“éªŒ

## ğŸ“ ç»´æŠ¤æŒ‡å—

### æ—¥å¸¸ç»´æŠ¤
- å®šæœŸæ£€æŸ¥é…ç½®æ–‡ä»¶ä¸€è‡´æ€§
- ç›‘æ§å¡ç‰‡æ“ä½œæˆåŠŸç‡
- åŠæ—¶æ›´æ–°æ¨¡æ¿ç‰ˆæœ¬

### é—®é¢˜æ’æŸ¥
1. æ£€æŸ¥é…ç½®æ–‡ä»¶æ ¼å¼
2. éªŒè¯ç®¡ç†å™¨æ³¨å†ŒçŠ¶æ€
3. æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
4. ç¡®è®¤æ¨¡æ¿IDæœ‰æ•ˆæ€§

### ç‰ˆæœ¬å‡çº§
1. å¤‡ä»½ç°æœ‰é…ç½®
2. æ›´æ–°ä»£ç å’Œé…ç½®
3. éªŒè¯å…¼å®¹æ€§
4. ç°åº¦å‘å¸ƒæµ‹è¯•

---

*æœ¬æ–‡æ¡£å°†éšç€å¡ç‰‡æ¨¡å—çš„æ¼”è¿›æŒç»­æ›´æ–°ï¼Œç¡®ä¿ä¸å®é™…å®ç°ä¿æŒåŒæ­¥ã€‚*