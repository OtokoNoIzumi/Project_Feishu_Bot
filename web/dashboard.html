<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diet & Keep - Dashboard</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;1,400&family=Patrick+Hand&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="css/styles.css?v=warm_07">
    <link rel="stylesheet" href="css/dashboard.css?v=warm_07">
    <link rel="stylesheet" href="css/sidebar.css?v=warm_07">
    <link rel="stylesheet" href="css/demo.css">
    <script type="module" src="js/utils/icons.js"></script>
    <script src="config.js"></script>
    <script>
        // Clerk SDK 动态加载 - 使用 CONFIG 中的 Key
        (function () {
            const script = document.createElement('script');
            script.setAttribute('data-clerk-publishable-key', CONFIG.CLERK_PUBLISHABLE_KEY);
            script.src = 'https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js';
            script.async = true;
            script.crossOrigin = 'anonymous';
            document.head.appendChild(script);
        })();
    </script>
</head>

<body>
    <div class="app-container">
        <!-- 左侧：历史记录栏 -->
        <aside class="history-panel">
            <div class="panel-header">
                <span class="brand-icon"><img src="css/icons/apple.png" class="icon-sticker lg" alt="Logo"></span>
                <span class="brand-name">Diet & Keep</span>
            </div>

            <div class="side-menu" id="side-menu">
                <button class="side-menu-item active" data-view="analysis"><img src="css/icons/notepad.png"
                        class="icon-stamp" alt="Analysis"> 分析</button>
                <button class="side-menu-item" data-view="profile"><img src="css/icons/gear.png" class="icon-stamp"
                        alt="Profile"> Profile</button>
            </div>

            <div class="history-list" id="history-list">
                <!-- 顶部工具栏 (Phase 2) -->
                <div class="sidebar-tools"
                    style="padding: 8px 12px; display: flex; gap: 8px; border-bottom: 1px solid var(--color-border);">
                    <!-- 搜索框占位 -->
                    <div style="flex:1"></div>
                    <!-- 新对话按钮 -->
                    <button id="new-dialogue-btn" title="新对话"
                        style="background:transparent; border:none; cursor:pointer; font-size:1.2rem; color:var(--color-accent-primary);">+</button>
                </div>

                <div id="dialogue-list-container">
                    <div class="history-section-title">今天</div>
                    <!-- 历史记录会动态填充 -->
                    <div class="history-item placeholder">加载中...</div>
                </div>
            </div>

            <div class="history-footer">
                <div id="user-button"></div>
            </div>
        </aside>

        <!-- 中间：确认/结果面板（最宽） -->
        <main class="result-panel">
            <div class="result-header">
                <div class="result-header-left">
                    <button class="result-close-btn" id="result-close-btn" title="折叠">✕</button>
                    <h2 id="result-title">分析结果</h2>
                </div>
                <div class="result-status" id="result-status"></div>
            </div>

            <div id="result-content" class="result-content">
                <div class="empty-state">
                    <div class="empty-icon"><img src="css/icons/bowl.png" class="icon-stamp xl" alt="Empty"
                            style="opacity: 0.5;"></div>
                    <h3>等待分析</h3>
                    <p>上传食物图片或输入描述开始分析</p>
                </div>
            </div>

            <div id="result-footer" class="result-footer hidden">
                <button class="btn btn-secondary" id="re-analyze-btn"><img src="css/icons/refresh.png"
                        class="icon-stamp" alt="Redo"> 重新分析</button>
                <button class="btn btn-secondary" id="update-advice-btn"><img src="css/icons/sparkle.png"
                        class="icon-stamp" alt="Update"> 更新建议</button>
                <button class="btn btn-primary" id="save-btn"><img src="css/icons/pin.png" class="icon-sticker"
                        alt="Save"> 保存记录</button>
            </div>
        </main>

        <div class="result-overlay hidden" id="result-overlay"></div>

        <!-- 右侧：输入区（对话 + 输入框始终保留） -->
        <section class="input-panel">
            <div class="mobile-header">
                <button id="mobile-sidebar-toggle" class="header-icon-btn">☰</button>
                <div class="header-title">Diet & Keep</div>
                <div id="user-button-mobile"></div>
            </div>
            <div class="chat-messages" id="chat-messages">
                <div class="message assistant">你好！上传食物图片或描述饮食，我来帮你分析。</div>
            </div>

            <div class="input-area">
                <div id="limit-status-container" class="limit-status hidden"></div>
                <div id="preview-container" class="preview-container hidden"></div>

                <div class="input-box" id="input-box">
                    <textarea id="chat-input" placeholder="描述你的饮食..." rows="1"></textarea>
                    <div class="input-toolbar">
                        <div class="toolbar-left">
                            <button class="tool-btn" id="upload-btn" title="上传图片"><img src="css/icons/add.png"
                                    class="icon-stamp" alt="Add"></button>
                            <input type="file" id="file-input" accept="image/*" multiple hidden>
                            <!-- Mobile buttons removed as requested -->
                            <div class="mode-switch">
                                <button class="mode-btn active" data-mode="diet">饮食</button>
                                <button class="mode-btn" data-mode="keep">Keep</button>
                                <button class="mode-btn" data-mode="advice">顾问</button>
                            </div>
                        </div>
                        <button id="send-btn" class="send-btn" disabled>发送</button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script src="js/auth.js" defer></script>
    <script src="js/config/demo_scenario.js" defer></script>
    <!-- Markdown 解析库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
    <script src="js/api.js" defer></script>
    <!-- 工具模块 -->
    <script src="js/utils/energy.js" defer></script>
    <script src="js/utils/image.js" defer></script>
    <script src="js/utils/text.js" defer></script>
    <script src="js/utils/date_formatter.js" defer></script>
    <script src="js/utils/toast.js" defer></script>
    <script src="js/modules/error-handler.js" defer></script>
    <script src="js/modules/parser.js" defer></script>

    <script src="js/modules/session.js" defer></script>
    <script src="js/modules/session-manager.js" defer></script>
    <script src="js/modules/dashboard-ui.js" defer></script>
    <script src="js/modules/analysis.js" defer></script>
    <script src="js/modules/profile.js" defer></script>
    <script src="js/modules/profile-render.js" defer></script>
    <script src="js/modules/diet-render.js" defer></script>
    <script src="js/modules/protein-report.js" defer></script>
    <script src="js/modules/keep-render.js" defer></script>
    <script src="js/modules/diet-edit.js" defer></script>
    <script src="js/modules/storage.js" defer></script>
    <script src="js/modules/footer.js" defer></script>

    <script type="module" src="js/modules/sidebar.js"></script>
    <!-- ECharts 图表库 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js" defer></script>
    <script src="js/modules/nutrition-chart.js" defer></script>
    <script src="js/modules/quick-input.js" defer></script>

    <script src="js/modules/demo.js" defer></script>
    <script src="js/modules/chat-ui.js" defer></script>
    <!-- 主控制器 -->
    <script src="js/dashboard.js" defer></script>
</body>

</html>