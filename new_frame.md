# é£ä¹¦æœºå™¨äººä¸å‰ç«¯é‡æ„è®¡åˆ’ (New Frame)
## 1. æ ¸å¿ƒç›®æ ‡
å°†ç°æœ‰çš„åç«¯ `analyze` å’Œ `save` èƒ½åŠ›ä¸é£ä¹¦å‰ç«¯æ·±åº¦æ•´åˆï¼Œå®ç°â€œå³æ—¶å“åº”ã€å¯è§†åŒ–ç¼–è¾‘ã€é—­ç¯æ“ä½œâ€çš„é«˜æ•ˆäº¤äº’ä½“éªŒã€‚åŒæ—¶è§„åˆ’ç‹¬ç«‹ Web App å‰ç«¯ä»¥åº”å¯¹æœªæ¥æ›´å¤æ‚çš„äº¤äº’éœ€æ±‚ã€‚

## 1.1 äº§å“äº¤äº’åŸåˆ™ï¼ˆå¿…é¡»é•¿æœŸéµå®ˆï¼‰
- **é¿å…ç ´åä¸ä¸å¯é€†æ“ä½œ**ï¼šé™¤éæ”¶ç›Šéå¸¸æ˜ç¡®ï¼Œå¦åˆ™ä¼˜å…ˆä½¿ç”¨â€œå¯ç”¨/åœç”¨ï¼ˆå‹¾é€‰ï¼‰â€â€œæ’¤é”€/æ¢å¤â€è¿™ç±»å¯é€†äº¤äº’ï¼Œé¿å…ç›´æ¥åˆ é™¤ç­‰ç ´åæ€§æ“ä½œã€‚AI è‡ªåŠ¨è¯†åˆ«çš„æ•°æ®å°¤å…¶å¦‚æ­¤ï¼Œé»˜è®¤åº”å¯å›é€€ã€‚
## 2. é£ä¹¦å¡ç‰‡äº¤äº’é‡æ„è®¾è®¡
### 2.1 è§¦å‘æœºåˆ¶ (Trigger)
é‡‡ç”¨ POST æ¨¡å¼ï¼ŒåŸºäº **Title (æ ‡é¢˜)** è¿›è¡Œç²¾å‡†è·¯ç”±åˆ†å‘ï¼š
*   **Diet (é¥®é£Ÿ)**: åŒ¹é… `Diet`, `diet`, `d`, `D`
*   **Keep (è¿åŠ¨/å¥åº·)**: åŒ¹é… `Keep`, `keep`, `k`, `K`
### 2.2 äº¤äº’æµç¨‹ (Workflow)
#### A. åˆå§‹é˜¶æ®µï¼šå³æ—¶åé¦ˆ (Immediate Response)
*   **åŠ¨ä½œ**: ç”¨æˆ·å‘é€å¸¦å›¾ç‰‡/æ–‡æœ¬çš„ POST è¯·æ±‚ã€‚
*   **ç³»ç»Ÿ**: ä¸ç­‰å¾…åˆ†æç»“æœï¼Œ**ç«‹å³**è¿”å›ä¸€å¼ â€œç¼–è¾‘/åŠ è½½å¡ç‰‡â€ã€‚
*   **å¡ç‰‡å†…å®¹**:
    *   **ç”¨æˆ·å¤‡æ³¨ (User Note)**: è¾“å…¥æ¡†ï¼Œå›æ˜¾ç”¨æˆ·å‘é€çš„æ–‡æœ¬ï¼Œå…è®¸ç«‹å³ä¿®æ”¹ã€‚
    *   **æ—¶é—´/æ—¥æœŸ**: æ—¥æœŸé€‰æ‹©å™¨ + æ—¶é—´æ®µä¸‹æ‹‰èœå• (æ—©é¤/åˆé¤/æ™šé¤/åŠ é¤)ï¼Œé»˜è®¤å½“å‰æ—¶é—´ã€‚
    *   **çŠ¶æ€æ **: æ˜¾ç¤ºâ€œæ­£åœ¨è¯†åˆ«ä¸­...â€åŠ¨ç”»æˆ–å›¾æ ‡ã€‚
    *   **åå°**: å¯åŠ¨å¼‚æ­¥åˆ†æä»»åŠ¡ (Diet/Keep Analyze)ã€‚
#### B. åˆ†æå®Œæˆï¼šæ•°æ®å±•ç¤º (Data Presentation)
*   **åŠ¨ä½œ**: åç«¯åˆ†æå®Œæˆï¼Œå¼‚æ­¥æ›´æ–°åŒä¸€å¼ å¡ç‰‡ã€‚
*   **Diet å¡ç‰‡æ›´æ–°**:
    *   **è¯†åˆ«ç»“æœ**: å±•ç¤ºè¯†åˆ«åˆ°çš„èœå“åˆ—è¡¨ (å¯ç¼–è¾‘åç§°/çƒ­é‡é¢„ä¼°)ã€‚
    *   **è¥å…»æ¦‚è§ˆ**: åŠ¨æ€å±•ç¤ºå¡è·¯é‡Œã€ä¸‰å¤§è¥å…»ç´  (å¦‚æœ‰)ã€‚
*   **Keep å¡ç‰‡æ›´æ–°**:
    *   **è¶‹åŠ¿æ•°æ®**: (æš‚æ—  Keep å¤æ‚åˆ†æ) å±•ç¤ºæš‚æ—¶çš„â€œç®€æ˜“å»ºè®®â€ï¼ŒåŒ…å«è¿‡å»å‡ æ—¥çš„æ•°æ®å¯¹æ¯”å’Œå˜åŒ–è¶‹åŠ¿ã€‚
    *   **æ•°æ®å½•å…¥**: å…è®¸æ‰‹åŠ¨æ ¡æ­£è¿åŠ¨æ•°æ® (å¦‚æ—¶é•¿ã€æ¶ˆè€—)ã€‚
#### C. åŠŸèƒ½æ“ä½œåŒº (Action Bar)
ä½äºå¡ç‰‡åº•éƒ¨ï¼Œæä¾›æ ¸å¿ƒæ“ä½œï¼š
1.  **é‡æ–°è¯†åˆ« (Re-Analyze)** (Refresh Icon)
    *   **é€»è¾‘**: ç”¨æˆ·ä¿®æ”¹ `User Note` åç‚¹å‡»ã€‚
    *   **è¡Œä¸º**: æºå¸¦æœ€æ–°çš„ Note å’Œå›¾ç‰‡ ID å†æ¬¡è°ƒç”¨ Backend Analyze APIã€‚
    *   **ç¼“å­˜**: éœ€åœ¨ Redis/å†…å­˜ä¸­ç¼“å­˜ `image_key`ï¼Œæœ‰æ•ˆæœŸå»ºè®® 1 å°æ—¶ (è¶…è¿‡ 3 å¼ æˆ–è¶…æ—¶åˆ™å¤±æ•ˆï¼Œå¡ç‰‡æ˜¾ç¤ºâ€œå·²å¤±æ•ˆâ€)ã€‚
    *   **UI**: çŠ¶æ€é‡ç½®ä¸ºâ€œæ­£åœ¨è¯†åˆ«...â€ã€‚
2.  **æ›´æ–°å»ºè®® (Update Advice)** (Magic Icon)
    *   **é€»è¾‘**: åŸºäºå½“å‰å¡ç‰‡ä¸Šçš„æ•°æ®ç”Ÿæˆ/åˆ·æ–°å»ºè®®ã€‚
    *   **çŠ¶æ€**: åˆå§‹ä¸ºç°è‰² (æˆ–æ˜¾ç¤ºä¸Šæ¬¡å»ºè®®)ã€‚åªæœ‰å½“æ•°æ®å‘ç”Ÿæ˜¾è‘—å˜åŒ– (å¦‚ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹äº†èœå“) æˆ–ç”¨æˆ·å¼ºåˆ¶ç‚¹å‡»æ—¶æ¿€æ´»ã€‚
    *   **ç¼“å­˜**: å»ºè®®å†…å®¹éœ€ç¼“å­˜ã€‚å¦‚æœæ•°æ®æœªå˜ï¼Œç›´æ¥è¯»å–ç¼“å­˜ï¼Œé¿å…æµªè´¹ LLM Tokenã€‚
3.  **ä¿å­˜æ•°æ® (Save Data)** (Check/Save Icon)
    *   **é€»è¾‘**: æäº¤å¡ç‰‡ä¸Šçš„æœ€ç»ˆæ•°æ® (Final State) åˆ°åç«¯ã€‚
    *   **æ¥å£**: è°ƒç”¨é€šç”¨ `Update/Append` æ¥å£ (å³ `DietCommitRequest`)ï¼Œå°†æ•°æ®å†™å…¥ `user_data`ã€‚
    *   **åé¦ˆ**: ä¿å­˜æˆåŠŸåï¼ŒæŒ‰é’®å˜ç»¿æˆ–å¡ç‰‡è½¬ä¸ºâ€œå·²å½’æ¡£â€åªè¯»çŠ¶æ€ã€‚
### 2.3 å…³é”®ç»„ä»¶ä¸æŠ€æœ¯ç»†èŠ‚
*   **ä¸‹æ‹‰èœå•**:
    *   `diet_time`: æ—©/åˆ/æ™š/åŠ é¤ (åŸºäºæ—¶é—´è‡ªåŠ¨é¢„é€‰)ã€‚
    *   `date`: æ—¥æœŸé€‰æ‹©å™¨ (é»˜è®¤ä¸º `today`)ã€‚
*   **çŠ¶æ€ç¼“å­˜ç­–ç•¥**:
    *   åˆ©ç”¨ `message_id` ä½œä¸º Keyã€‚
    *   ç¼“å­˜å†…å®¹: `original_image_keys`, `current_analysis_result`, `last_advice_hash`, `user_note_draft`.
    *   æ·˜æ±°ç­–ç•¥: LRU (æœ€è¿‘æœ€å°‘ä½¿ç”¨)ï¼Œä¿ç•™æœ€è¿‘ 5-10 æ¡ä¼šè¯ä¸Šä¸‹æ–‡å³å¯ã€‚
    *   **å®ç°å»ºè®®**: åœ¨ Redis ä¸­å­˜å‚¨ `card_id` -> `{user_note, image_keys, current_result}` çš„ä¸´æ—¶æ˜ å°„ï¼ŒTTL 1å°æ—¶ã€‚

### 2.4 æ¶‰åŠæ–‡ä»¶ä¸æ”¹åŠ¨ (Technical Implementation Map)
*   **`message_handler.py`**:
    *   æ–°å¢ `_handle_keep_analyze_async`: å‘é€å ä½ç¬¦ -> è°ƒç”¨åç«¯ -> æ¸²æŸ“ `KeepAnalysisCard`ã€‚
    *   é‡æ„ `_handle_diet_analyze_async`: é€‚é…æ–°çš„â€œè¾“å…¥ä¼˜å…ˆâ€äº¤äº’é€»è¾‘ã€‚
*   **å¡ç‰‡æ„å»ºå™¨ (New Files)**:
    *   `Module/Adapters/feishu/cards/keep_cards/keep_analysis_card.py`: å®ç° `KeepAnalysisCardBuilder`ã€‚
    *   `Module/Adapters/feishu/cards/diet_cards/diet_analysis_card.py`: å‡çº§ä¸ºäº¤äº’å¼å¡ç‰‡ï¼Œå¢åŠ  `Diet Time` Select ç»„ä»¶ã€‚
*   **`card_handler.py`**:
    *   æ³¨å†ŒåŠ¨ä½œ: `keep_re_analyze`, `keep_save`, `diet_re_analyze`, `diet_save`.
    *   é€»è¾‘: ä» Cache è¯»å–åŸå§‹ Contextï¼Œåˆå¹¶å½“å‰ Form æ•°æ®è¿›è¡ŒäºŒæ¬¡æäº¤ã€‚
---
## 3. Web App ç‹¬ç«‹å‰ç«¯æ·±åº¦è§„åˆ’ (Strategic Roadmap)

æ—¢ç„¶ç¡®å®šè¦ç‹¬ç«‹ App åŒ–ï¼Œæˆ‘ä»¬éœ€è¦ç›´æ¥é‡‡ç”¨â€œç”Ÿäº§çº§â€æ¶æ„ï¼Œè€Œéä¸´æ—¶çš„è¿‡æ¸¡æ–¹æ¡ˆã€‚

### 3.1 æ ¸å¿ƒå¸ƒå±€ï¼šChat + Dynamic Side Panel (Copilot æ¨¡å¼)
ä¸å†æ˜¯ç®€å•çš„â€œèŠå¤©çª—å£â€ï¼Œè€Œæ˜¯é‡‡ç”¨**ä¸‰æ å¼å¸ƒå±€** (æ¡Œé¢ç«¯) / **æŠ½å±‰å¼å¸ƒå±€** (ç§»åŠ¨ç«¯)ï¼š

*   **å·¦ä¾§ (å¯¼èˆª/å†å²)**: å¿«é€Ÿåˆ‡æ¢ Sessionï¼ŒæŸ¥çœ‹å†å²è®°å½•ã€‚
*   **ä¸­é—´ (Chat Flow)**:
    *   ä¼ ç»Ÿçš„å¯¹è¯æµï¼Œç”¨äºå‘é€æŒ‡ä»¤ï¼ˆâ€œåˆ†æè¿™ä¸ªå›¾ç‰‡â€ã€â€œæ˜¨å¤©çš„çƒ­é‡æ˜¯å¤šå°‘â€ï¼‰ã€‚
    *   **å…³é”®ç‚¹**: å¯¹è¯æ°”æ³¡ä¸­ä¸å†åŒ…å«å¤æ‚çš„ç¼–è¾‘è¡¨æ ¼ï¼Œè€Œæ˜¯åªæ˜¾ç¤ºâ€œæ‘˜è¦â€æˆ–â€œå¡ç‰‡å…¥å£â€ã€‚
*   **å³ä¾§ (Dynamic Artifact Panel / åŠ¨æ€äº¤äº’é¢æ¿)**:
    *   è¿™æ˜¯ React/HTML çš„æ ¸å¿ƒä¼˜åŠ¿åŒºåŸŸã€‚å½“ç”¨æˆ·ç‚¹å‡»â€œåˆ†æâ€æˆ–èŠå¤©ä¸­å‡ºç°éœ€è¦ç¡®è®¤çš„æ•°æ®æ—¶ï¼Œå³ä¾§é¢æ¿å±•å¼€ã€‚
    *   **å¸¸é©»çŠ¶æ€**: è¿™é‡Œåƒä¸€ä¸ªâ€œè‰ç¨¿çº¸â€æˆ–â€œæ§åˆ¶å°â€ã€‚
    *   **Keep/Diet åœºæ™¯**: å³ä¾§æ˜¾ç¤ºä¸Šä¼ çš„å›¾ç‰‡ï¼ˆæ”¯æŒ**æ‹–æ‹½ã€è£å‰ªã€æ”¾å¤§**ï¼‰ï¼Œä¸‹æ–¹æ˜¯ç»“æ„åŒ–çš„æ•°æ®è¡¨å• (Form)ã€‚

---
## 3.8 å½“å‰è¿›åº¦ï¼ˆæˆªè‡³ 2026-01-11ï¼‰
### å·²å®Œæˆ
- **Web åŸºç¡€æ¡†æ¶**ï¼š`web/` çº¯é™æ€å‰ç«¯ + Clerk ç™»å½• + ä¸ FastAPI API é€šä¿¡
- **ä¸‰æ å¸ƒå±€é›å½¢**ï¼šå·¦ä¾§å†å²/å…¥å£ + ä¸­é—´ç¡®è®¤é¢æ¿ + å³ä¾§å¯¹è¯è¾“å…¥ï¼›ç§»åŠ¨ç«¯ç¡®è®¤é¢æ¿æŠ½å±‰åŒ–
- **Diet**
  - **èœå¼è¡¨æ ¼ç¼–è¾‘**ï¼šæ”¯æŒç¼–è¾‘è›‹ç™½/è„‚è‚ª/ç¢³æ°´/è†³é£Ÿçº¤ç»´/é’ /é‡é‡
  - **å¯ç”¨/åœç”¨äº¤äº’**ï¼šAI è¯†åˆ«èœå¼ç¦æ­¢åˆ é™¤ï¼Œæ”¹ä¸ºå‹¾é€‰å¯ç”¨ä¸å¦ï¼›ä»…ç”¨æˆ·æ–°å¢èœå¼å…è®¸åˆ é™¤
  - **åŠ¨æ€æ±‡æ€»**ï¼šæ€»èƒ½é‡/ä¸‰å¤§è¥å…»/çº¤ç»´/é’ /æ€»é‡é‡è‡ªåŠ¨åŠ æ€»
- **Keep**
  - è¯†åˆ«ç»“æœä¿æŒåªè¯»å±•ç¤ºï¼ˆä¸æä¾›ç¼–è¾‘å…¥å£ï¼‰
- **Profileï¼ˆå‰ç«¯å…ˆè¡Œï¼‰**
  - å¢åŠ  Profile å­ç•Œé¢ï¼šæ—¶åŒº + Diet/Keep ç›®æ ‡é…ç½®
  - å¢åŠ â€œèƒ½é‡æ˜¾ç¤ºå•ä½â€åˆ‡æ¢ï¼ˆé»˜è®¤ kJï¼Œç«‹å³ç”Ÿæ•ˆï¼‰

### å·²çŸ¥é—®é¢˜ï¼ˆåç»­å¤„ç†ï¼‰
- **ç§»åŠ¨ç«¯æ•´ä½“é€‚é…ä»éœ€ç»†åŒ–**ï¼šç›®å‰ä¼˜å…ˆä¿è¯â€œè¾“å…¥æ ç½®åº• + ç¡®è®¤é¢æ¿å¯å‘¼å‡º/æŠ˜å  + æ— æ¨ªå‘æ»šåŠ¨ç¼–è¾‘â€çš„å¯ç”¨æ€§ï¼Œå…¶ä»–è§†è§‰ä¸äº¤äº’ç»†èŠ‚å¾…é›†ä¸­ä¼˜åŒ–ã€‚

### 3.9 Web å‰ç«¯ TODO List

> ä¼˜å…ˆçº§è¯´æ˜ï¼šS=é˜»å¡çº§ï¼ˆå½±å“æ ¸å¿ƒåŠŸèƒ½ï¼‰ã€A=é«˜ä¼˜ï¼ˆå½±å“ç”¨æˆ·ä½“éªŒï¼‰ã€B=ä¸­ä¼˜ï¼ˆä½“éªŒä¼˜åŒ–ï¼‰ã€C=ä½ä¼˜ï¼ˆé”¦ä¸Šæ·»èŠ±ï¼‰

#### å¾…ä¿®å¤ç‘•ç–µ

| ä¼˜å…ˆçº§ | ç¼–å· | é—®é¢˜æè¿° | æ¶‰åŠèŒƒå›´ | çŠ¶æ€ |
|--------|------|----------|----------|------|
| **S** | BUG-001 | ç‚¹å‡»"é‡æ–°åˆ†æ"åä¿å­˜çš„æ•°æ®å˜ç©º `{}` | å‰ç«¯ `collectEditedData` æˆ–çŠ¶æ€ç®¡ç† | ğŸ”´ æç½®ï¼ˆæœªå¤ç°ï¼Œæç½®ï¼‰ |
| **S** | BUG-002 | DIET/KEEPï¼šä¿å­˜æœªæ­£ç¡®æ²¿ç”¨ analyze è¿”å›çš„ `occurred_at`ï¼ˆåº”ç¼“å­˜å¹¶æœ€ç»ˆå†™å…¥å¯¹åº”æ•°æ®ä¸æ–‡ä»¶ï¼‰ | å‰ç«¯ `saveRecord` + åç«¯ storage | âœ… å·²ä¿® (2026-01-15) |
| **B** | BUG-003 | advice æ–‡æœ¬æœªæ¸²æŸ“ markdown æ ¼å¼ï¼ˆæ¢è¡Œã€ç²—ä½“ç­‰ï¼‰ | å‰ç«¯ `renderAdvice` | âœ… å·²ä¿® (2026-01-13) |
| **S** | BUG-004 | KEEPï¼šå¤šå›¾åœºæ™¯ä¿å­˜ä¼šæŠŠå¤šæ¬¡åˆ†æ/å¤šå¼ å›¾çš„ç»“æœæ··åœ¨ä¸€èµ·ï¼ˆæ•°æ®ä¸²è”/æ±¡æŸ“ï¼‰ | å‰ç«¯ Session/Version + ä¿å­˜é“¾è·¯ | âœ… å·²ä¿® (2026-01-15) |
| **A** | BUG-005 | DIETï¼šç¼–è¾‘è¥å…»ç´ åè‡ªåŠ¨é‡ç®—è§¦å‘é‡æ–°æ¸²æŸ“ï¼Œè¾“å…¥æ¡†ç„¦ç‚¹ä¸¢å¤±ï¼Œå¯¼è‡´æ— æ³•è¿ç»­è¾“å…¥ï¼ˆä¾‹å¦‚ 2.1 æ”¹ 12ï¼‰ | å‰ç«¯ `updateDish/updateIngredient` â†’ `recalculateDietSummary` â†’ `renderDietDishes` | âœ… å·²ä¿® (2026-01-15) |

#### å¾…å¼€å‘åŠŸèƒ½

| ä¼˜å…ˆçº§ | ç¼–å· | åŠŸèƒ½æè¿° | æ¶‰åŠèŒƒå›´ | çŠ¶æ€ |
|--------|------|----------|----------|------|
| **A** | FEAT-001 | è¥å…»æ‘„å…¥å¯è§†åŒ–å›¾è¡¨ï¼ˆè¯¦è§ Â§3.10ï¼‰ | å‰ç«¯ ECharts + äº¤äº’ | âœ… å·²å®Œæˆ (2026-01-14) |
| **A** | FEAT-003 | å¤±è´¥ä¸€é”®é‡è¯•æœºåˆ¶ï¼ˆé¿å…é‡æ–°è¾“å…¥ï¼‰ | å‰ç«¯ Error UX | âœ… å·²å®Œæˆ (2026-01-15) |
| **A** | FEAT-004 | è¥å…»ç‚¹è¯„åŒºåŸŸå¯æŠ˜å ï¼ˆè¯¦è§ Â§3.10ï¼‰ | å‰ç«¯ UI | âœ… å·²å®Œæˆ (2026-01-14) |
| **B** | FEAT-002 | è¥å…»æ ‡ç­¾äº§å“åä¸‹æ‹‰é€‰æ‹©ï¼ˆä» product library é€‰æ‹©ï¼‰ | å‰ç«¯ UI + API | â¬œ å¾…å¼€å‘ |
| **B** | OPT-001 | ä¼˜åŒ–å“åº”è¶…æ—¶(60s)ä¸è¯·æ±‚è€—æ—¶æ—¥å¿— | åç«¯ Server | âœ… å·²å®Œæˆ (2026-01-15) |
| **B** | REFACTOR-001 | dashboard.js æ‹†åˆ†é‡æ„ï¼ˆ2290è¡Œâ†’æ¨¡å—åŒ–ï¼‰ | å‰ç«¯æ¶æ„ | âœ… å·²å®Œæˆ (2026-01-14) |
| **B** | REFACTOR-002 | get_product_memories é€»è¾‘ä¸æ•°æ®ç»“æ„é‡æ„ | åç«¯ Logic | â¬œ å¾…è§„åˆ’ |

#### å·²å®Œæˆ (2026-01-13)

| ç¼–å· | é—®é¢˜/åŠŸèƒ½ | è§£å†³æ–¹æ¡ˆ |
|------|----------|----------|
| P0 | ç­‰æ¯”ç¼©æ”¾å¼€å…³ | æ¯ä¸ªæˆåˆ†ç‹¬ç«‹å¼€å…³ï¼Œç”¨ âš– å›¾æ ‡è¡¨ç¤º |
| P2 | advice è‡ªåŠ¨è§¦å‘ | åˆ†æå®Œæˆåè‡ªåŠ¨è¯·æ±‚å»ºè®®ï¼Œæ·»åŠ  loading çŠ¶æ€ |
| P1 | labels_snapshot å±•ç¤º | åº•éƒ¨å¯æŠ˜å åŒºåŸŸï¼Œæ”¯æŒç¼–è¾‘ product_name/brand/variant/custom_note |
| FIX | advice å“åº”è§£æé”™è¯¯ | ä¿®å¤ `response.result.advice_text` è§£åŒ… |
| FIX | ç­‰æ¯”ç¼©æ”¾å›¾æ ‡ä¸ç›´è§‚ | ä» ğŸ”—/â›“ï¸ æ”¹ä¸º âš–ï¼ˆç”±ç”¨æˆ·æ‰‹åŠ¨è°ƒæ•´ï¼‰ |

#### å·²å®Œæˆ (2026-01-14)

| ç¼–å· | é—®é¢˜/åŠŸèƒ½ | è§£å†³æ–¹æ¡ˆ |
|------|----------|----------|
| REFACTOR-001 | dashboard.js æ‹†åˆ†é‡æ„ | 2342è¡Œ â†’ 910è¡Œï¼Œæ‹†åˆ†ä¸º 9 ä¸ªæ¨¡å— |
| FIX | åˆ†æå¤±è´¥åä¸€ç›´è½¬åœˆ | `showError()` ä¸­æ·»åŠ  `updateStatus('')` æ¸…é™¤åŠ è½½çŠ¶æ€ |
| FIX | æ€»èƒ½é‡å•ä½æ˜¾ç¤ºé”™è¯¯ | å†…éƒ¨ç»Ÿä¸€ kcal è®¡ç®—ï¼Œå±•ç¤ºæŒ‰ Profile èƒ½é‡å•ä½(kJ/kcal)æ¢ç®—ï¼›ä¿å­˜é¿å…äºŒæ¬¡æ¢ç®— |
| FIX | è¥å…»è¿›åº¦å›¾è¡¨å¯è¯»æ€§ | 6æ¡æ ‡ç­¾å…¨æ˜¾ç¤ºã€å•è¡Œæ ‡ç­¾ã€è¿›åº¦æ¡æ›´ç²—ã€Xè½´å¯¹ >100% åŠ¨æ€æ‰©å±•ã€é…è‰²ä¼˜åŒ– |
| FIX | å›¾è¡¨ Tooltip æç¤ºå¢å¼º | ç›®æ ‡åè¿½åŠ ç™¾åˆ†æ¯”ï¼›è„‚è‚ª/é’ ç”¨â€œè¿˜å‰©ä½™/å·²è¶…å‡ºâ€ï¼Œå…¶ä½™ç”¨â€œå·²æ‘„å…¥â€ |
| FIX | æŠ˜å äº¤äº’ç»Ÿä¸€ | è¥å…»è¿›åº¦ä¸ç‚¹è¯„å³ä¸Šè§’æŠ˜å æŒ‰é’®ï¼›ç‚¹è¯„é»˜è®¤å±•å¼€ã€ä»…æ‰‹åŠ¨ç‚¹å‡»æ”¶èµ· |

#### å·²å®Œæˆ (2026-01-15)

| ç¼–å· | é—®é¢˜/åŠŸèƒ½ | è§£å†³æ–¹æ¡ˆ |
|------|----------|----------|
| BUG-005 | è¿ç»­è¾“å…¥ç„¦ç‚¹ä¸¢å¤± | `diet-edit.js` å¼•å…¥ `updateDishDOM/updateDishRowDOM` å®ç° targeted DOM updateï¼Œé¿å…å…¨é‡é‡ç»˜ |
| UI | Profile æŒ‰é’®æ ·å¼ä¸ç»Ÿä¸€ | å°† Profile ç•Œé¢æ“ä½œæŒ‰é’®ç»Ÿä¸€ä¸º `.btn .btn-primary` é£æ ¼ï¼Œç§»é™¤æ—§çš„ `.profile-btn` |
| UI | Save Profileå›¾æ ‡å¯¹é½ | ç§»é™¤å›¾æ ‡æ¸²æŸ“çš„ `sm` å‚æ•°ï¼Œä¸ Save Record ä¿æŒå°ºå¯¸ä¸€è‡´ |
| UX | å¤±è´¥ä¸€é”®é‡è¯• | åˆ†æå¤±è´¥é¡µé¢å¢åŠ "é‡è¯•"æŒ‰é’®ï¼Œä¿ç•™ä¸Šä¸‹æ–‡é‡æ–°å‘èµ·è¯·æ±‚ |
| OPT | APIè¶…æ—¶ä¼˜åŒ– | APIè¯·æ±‚é»˜è®¤è¶…æ—¶æ”¹ä¸º120sï¼Œå¢åŠ è€—æ—¶æ—¥å¿—ï¼Œé˜²æ­¢LLMåˆ†æè¶…æ—¶ |
| BUG-002 | Diet/Keepä¿å­˜æ—¥æœŸé”™è¯¯ | ä¿®å¤å‰ç«¯ `saveDiet` å‚æ•°é€ä¼ æ¼æ´ï¼›åç«¯ Advice æ”¯æŒæŒ‰äº‹ä»¶æ—¥æœŸè·å–ä¸Šä¸‹æ–‡ï¼›Keep ä¿å­˜è‡ªåŠ¨æå–äº‹ä»¶æ—¶é—´ |
| BUG-004 | Keepæ•°æ®ä¿å­˜å¼‚å¸¸ | å‰ç«¯å¼ºåˆ¶å¯ç”¨ `unified` æ¨¡å¼ï¼Œåç«¯å®Œæ•´å®ç°å¤šäº‹ä»¶æ‹†åŒ…ä¿å­˜é€»è¾‘ï¼Œä¿®å¤æ•°æ®æ±¡æŸ“é—®é¢˜ |

**é‡æ„åæ¨¡å—æ¸…å•**ï¼š
| æ¨¡å— | è¡Œæ•° | èŒè´£ |
|------|------|------|
| `dashboard.js` | ~290 | ä¸»æ§åˆ¶å™¨ï¼šåˆå§‹åŒ–ã€çŠ¶æ€ç®¡ç†ã€è·¯ç”± |
| `utils/energy.js` | ~55 | èƒ½é‡è½¬æ¢ï¼ˆkcal/kJã€å®é‡è®¡ç®—ï¼‰ |
| `utils/image.js` | ~80 | å›¾ç‰‡å¤„ç†ï¼ˆä¸Šä¼ ã€é¢„è§ˆã€å“ˆå¸Œï¼‰ |
| `utils/text.js` | ~35 | æ–‡æœ¬å¤„ç†ï¼ˆMarkdown æ¸²æŸ“ï¼‰ |
| `modules/parser.js` | ~145 | åç«¯æ•°æ®è§£æä¸è½¬æ¢ |
| `modules/session.js` | ~135 | Session/æ¶ˆæ¯å¡ç‰‡æ¸²æŸ“ä¸ç®¡ç† |
| `modules/analysis.js` | ~150 | åˆ†ææµç¨‹ï¼ˆAPIè°ƒç”¨ã€ç‰ˆæœ¬ç®¡ç†ï¼‰ |
| `modules/diet-render.js` | ~420 | Diet æ¸²æŸ“ï¼ˆç»“æœã€è¡¨æ ¼ã€ç§»åŠ¨ç«¯ï¼‰ |
| `modules/diet-edit.js` | ~290 | Diet ç¼–è¾‘ï¼ˆå¢åˆ æ”¹ã€æ±‡æ€»ï¼‰ |
| `modules/keep-render.js` | ~105 | Keep æ¸²æŸ“ï¼ˆä½“é‡ã€ç¡çœ ã€å›´åº¦ï¼‰ |
| `modules/profile.js` | ~82 | Profile å·¥å…·å‡½æ•° |
| `modules/storage.js` | ~140 | å­˜å‚¨æ“ä½œï¼ˆä¿å­˜ã€å†å²ï¼‰ |

> **æ³¨**ï¼š`renderProfileView` (~250è¡Œ HTML æ¨¡æ¿) ä»åœ¨ dashboard.js ä¸­ï¼Œå¾…åç»­ç”¨ `<template>` æ ‡ç­¾ä¼˜åŒ–ã€‚

### 3.2 äº¤äº’ä¼˜åŠ¿ï¼šHTML App vs. é£ä¹¦å¡ç‰‡

| ç‰¹æ€§ | é£ä¹¦å¡ç‰‡ (Server-Driven) | HTML Web App (Client-First) | ä¼˜åŠ¿åœºæ™¯ |
| :--- | :--- | :--- | :--- |
| **çŠ¶æ€æ›´æ–°** | **é«˜å»¶è¿Ÿ**: ç‚¹å‡» -> åç«¯å¤„ç† -> å‘é€æ–°å¡ç‰‡json -> æ¸²æŸ“ (çº¦1-2ç§’) | **é›¶å»¶è¿Ÿ**: ä¿®æ”¹ State -> React è‡ªåŠ¨é‡æ¸²æŸ“ (æ¯«ç§’çº§)ã€‚ä»…åœ¨â€œä¿å­˜â€æ—¶è¯·æ±‚åç«¯ã€‚ | æ»‘åŠ¨æ¡è°ƒæ•´ä½“é‡ã€è¥å…»ç´ å¾®è°ƒ |
| **è¾“å…¥æ§ä»¶** | ä»…é™è¾“å…¥æ¡†ã€é€‰æ‹©å™¨ã€æ—¥æœŸã€‚ä¸æ”¯æŒæ»‘åŠ¨æ¡ (Slider) | **å…¨èƒ½åŠ›**: Slider (æ»‘åŠ¨æ¡), Switch, Drag & Drop (æ‹–æ‹½ä¸Šä¼ /æ’åº), Canvas (å›¾ç‰‡æ ‡æ³¨)ã€‚ | è°ƒæ•´é¥®é£Ÿå æ¯”ã€ä½“é‡å¾®è°ƒ |
| **å›¾ç‰‡äº¤äº’** | åªèƒ½æŸ¥çœ‹ï¼Œä¸å¯ç¼–è¾‘ã€‚ | **å¯ç¼–è¾‘**: æ”¯æŒå›¾ç‰‡è£å‰ªã€æ—‹è½¬ã€ç”»ç¬”æ ‡æ³¨ (æ¯”å¦‚åœˆå‡ºé£Ÿç‰©)ã€‚ | ä¿®æ­£è¯†åˆ«åŒºåŸŸ |
| **ç§»åŠ¨ç«¯** | åªèƒ½å‚ç›´å †å ï¼Œç©ºé—´åˆ©ç”¨ç‡ä½ã€‚ | **å“åº”å¼**: **Bottom Sheet (åº•éƒ¨æŠ½å±‰)**ã€‚ç‚¹å‡»èŠå¤©å¡ç‰‡ï¼Œåº•éƒ¨å¼¹å‡ºè¯¦ç»†ç¼–è¾‘é¡µï¼ˆå å± 80%ï¼‰ï¼Œä¸‹æ»‘å…³é—­ã€‚ | æ‰‹æœºå•æ‰‹æ“ä½œ |

### 3.3 æŠ€æœ¯æ ˆä¸é‰´æƒ (Authentication)
*   **æ¡†æ¶**: **Next.js 14+ (App Router)** + **Tailwind CSS** + **ShadcnUI** (ç¬¦åˆ Premium Design è¦æ±‚)ã€‚
*   **çŠ¶æ€ç®¡ç†**: **TanStack Query** (React Query) ç”¨äºå‰åç«¯çŠ¶æ€åŒæ­¥ã€‚
*   **é‰´æƒæ–¹æ¡ˆ (å¼ºçƒˆæ¨è)**: **Clerk**
    *   *ç†ç”±*: æ—©æœŸé€šè¿‡â€œé€šè¡Œè¯IDâ€è™½ç„¶ç®€å•ï¼Œä½†åæœŸè¿ç§»æˆæœ¬æé«˜ã€‚Clerk å¼€ç®±å³ç”¨æ”¯æŒ Google/Apple ç™»å½•ï¼Œä¸”å…è´¹é¢åº¦è¶³ä»¥è¦†ç›–æ—©æœŸé˜¶æ®µã€‚
    *   **é›†æˆæ–¹å¼**:
        1.  å‰ç«¯ä½¿ç”¨ `<ClerkProvider>`.
        2.  API è¯·æ±‚å¤´æºå¸¦ `Authorization: Bearer <token>`.
        3.  FastAPI åç«¯ç¼–å†™ Dependency è§£æ JWT token å¹¶æ˜ å°„åˆ° `user_id`.

### 3.4 æ”¯ä»˜ä¸å•†ä¸šåŒ– (Payment & MoR)
*   **é˜¶æ®µä¸€ï¼šéªŒè¯æœŸ (Seed)**
    *   **ç­–ç•¥**: æ‰‹åŠ¨è½¬è´¦ (å¾®ä¿¡/æ”¯ä»˜å®) -> Admin é¢æ¿æ‰‹åŠ¨å¼€é€šæƒé™ã€‚
    *   *ä¼˜åŠ¿*: é›¶æ‰‹ç»­è´¹ï¼Œç›´æ¥æ¥è§¦æ ¸å¿ƒç”¨æˆ·ï¼ŒéªŒè¯éœ€æ±‚ã€‚
*   **é˜¶æ®µäºŒï¼šè§„æ¨¡åŒ– (Scale)**
    *   **ç­–ç•¥**: ä½¿ç”¨ **Merchant of Record (MoR)** å¹³å°ï¼Œå¦‚ **LemonSqueezy**.
    *   *ä¼˜åŠ¿*: å¹³å°ä½œä¸ºâ€œç»é”€å•†â€å¤„ç†å…¨çƒç¨åŠ¡ (Tax compliant)ï¼Œä½ åªéœ€æ¥æ”¶ç»“ç®—æ¬¾ã€‚ç›¸æ¯” Stripe çº¯ç½‘å…³æ¨¡å¼ï¼ŒMoR æ›´é€‚åˆç‹¬ç«‹å¼€å‘è€…ï¼ˆæ— éœ€åœ¨æ—©æœŸæ³¨å†Œå¤æ‚çš„æµ·å¤–å…¬å¸å®ä½“ï¼‰ã€‚
*   **æ¨¡æ¿å‚è€ƒ**:
    *   **ShipFast**: åŒ…å« Next.js + Tailwind + Stripe/LemonSqueezy çš„æˆç†Ÿè„šæ‰‹æ¶ã€‚
    *   **Makerkit**: åŠŸèƒ½æ›´å…¨çš„ SaaS Starterã€‚

### 3.5 Web App å®æ–½æŒ‡å— (çº¯ HTML + Clerk)
**æ–¹æ¡ˆè°ƒæ•´**: æ”¾å¼ƒ Next.jsï¼Œé‡‡ç”¨**çº¯ HTML + JavaScript**ã€‚æ— éœ€å®‰è£… Node.js/npmï¼Œç›´æ¥å†™é™æ€é¡µé¢ã€‚

#### æŠ€æœ¯æ ˆ
*   **å‰ç«¯**: çº¯ HTML + Vanilla JS + CSS (å¯é€‰ Tailwind CDN)
*   **é‰´æƒ**: Clerk JavaScript SDK (`@clerk/clerk-js`)ï¼Œé€šè¿‡ `<script>` æ ‡ç­¾å¼•å…¥
*   **éƒ¨ç½²**: **GitHub Pages** (å…è´¹ã€æ— éœ€æœåŠ¡å™¨èµ„æº)
*   **åç«¯**: ç°æœ‰çš„ Python FastAPI (å·²éƒ¨ç½²åœ¨è¿œç¨‹æœåŠ¡å™¨)

#### ç›®å½•ç»“æ„
```
Project_Feishu_Bot/
â”œâ”€â”€ web/                      # æ–°å¢ï¼šçº¯é™æ€å‰ç«¯
â”‚   â”œâ”€â”€ index.html            # å…¥å£é¡µ (ç™»å½•/é¦–é¡µ)
â”‚   â”œâ”€â”€ dashboard.html        # ä¸»ç•Œé¢ (Chat + Side Panel)
â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â””â”€â”€ styles.css
â”‚   â”œâ”€â”€ js/
â”‚   â”‚   â”œâ”€â”€ auth.js           # Clerk åˆå§‹åŒ–ä¸ç™»å½•é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ api.js            # ä¸ FastAPI åç«¯é€šä¿¡
â”‚   â”‚   â””â”€â”€ app.js            # ä¸»ä¸šåŠ¡é€»è¾‘
â”‚   â””â”€â”€ config.js             # é…ç½® (API URL, Clerk Key)
â””â”€â”€ ...
```

#### å…³é”®æ­¥éª¤

1.  **Clerk åˆå§‹åŒ– (çº¯ JS)**:
    åœ¨ HTML çš„ `<head>` ä¸­å¼•å…¥ Clerk SDKï¼š
    ```html
    <script
      async
      crossorigin="anonymous"
      data-clerk-publishable-key="pk_test_YWR2YW5jZWQtcHVtYS01Mi5jbGVyay5hY2NvdW50cy5dZXYk"
      src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
      type="text/javascript"
    ></script>
    ```

2.  **ç™»å½•/ç™»å‡ºæŒ‰é’®**:
    Clerk ä¼šè‡ªåŠ¨æ¸²æŸ“åˆ°æŒ‡å®šçš„ `<div>`:
    ```html
    <div id="clerk-user-button"></div>
    <script>
      window.Clerk.load().then(() => {
        const userButtonDiv = document.getElementById("clerk-user-button");
        window.Clerk.mountUserButton(userButtonDiv);
      });
    </script>
    ```

3.  **è·å– Token è°ƒç”¨åç«¯ API**:
    ```javascript
    async function callBackendAPI(endpoint, data) {
      const token = await window.Clerk.session.getToken();
      const response = await fetch(`https://your-api.com${endpoint}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(data)
      });
      return response.json();
    }
    ```

#### éƒ¨ç½²æ–¹æ¡ˆï¼šGitHub Pages
*   **ä¼˜åŠ¿**: å…è´¹æ‰˜ç®¡é™æ€ç«™ç‚¹ï¼›ä¸å ç”¨ä½ çš„è¿œç¨‹æœåŠ¡å™¨èµ„æº (40G å†…å­˜ä¿æŒç»™ Python åç«¯)ã€‚
*   **æ­¥éª¤**:
    1.  åœ¨ GitHub ä»“åº“ Settings -> Pages -> Source é€‰æ‹© `main` åˆ†æ”¯ `/web` ç›®å½•ã€‚
    2.  è®¿é—® `https://yourusername.github.io/Project_Feishu_Bot/` å³å¯ã€‚
*   **CORS æ³¨æ„**: FastAPI åç«¯éœ€è¦é…ç½® `CORSMiddleware` å…è®¸æ¥è‡ª GitHub Pages åŸŸåçš„è¯·æ±‚ã€‚

### 3.6 ç”¨æˆ·æ•°æ®å…³è”ç­–ç•¥ (Feishu <-> Web)
å¦‚ä½•è®©ç½‘é¡µç«¯ç™»å½•çš„ç”¨æˆ· (Clerk ID) çœ‹åˆ°é£ä¹¦ç«¯ (Feishu Open ID) äº§ç”Ÿçš„æ•°æ®ï¼Ÿ

**æ–¹æ¡ˆ Aï¼šæ‰‹åŠ¨æ˜ å°„ (MVP æ¨è)**
*   **åŸç†**: æ—©æœŸç”¨æˆ·æå°‘ï¼ˆåªæœ‰ä½ è‡ªå·±æˆ–äº²å‹ï¼‰ã€‚
*   **æ“ä½œ**:
    1.  ç”¨æˆ·åœ¨ç½‘é¡µç«¯æ³¨å†Œ/ç™»å½• (ç”Ÿæˆ `clerk_user_id`, å¦‚ `user_2p...`)ã€‚
    2.  ç®¡ç†å‘˜ (ä½ ) åœ¨é…ç½®æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡ä¸­å»ºç«‹æ˜ å°„ï¼š
        ```json
        {
          "user_2pM...": "me"
        }
        ```
    3.  **åç«¯æ”¹é€ **: ä¿®æ”¹ `require_user` ä¾èµ–ã€‚å½“æ”¶åˆ° Clerk Token æ—¶ï¼Œè§£æå‡º `clerk_id`ï¼ŒæŸ¥æ˜ å°„è¡¨è½¬æ¢ä¸ºå¯¹åº”çš„ `user_id`ï¼Œç„¶åç”¨è¿™ä¸ª ID å»æŸ¥æ•°æ®ã€‚
*   **ä¼˜ç‚¹**: å¼€å‘æˆæœ¬å‡ ä¹ä¸ºé›¶ï¼Œæ•°æ®å®Œå…¨éš”ç¦»ï¼Œæ— éœ€å¤æ‚çš„"è´¦å·ç»‘å®š"ç•Œé¢ã€‚

**æ–¹æ¡ˆ Bï¼šç»Ÿä¸€è´¦æˆ·è¡¨ (é•¿æœŸ)**
*   **åŸç†**: æ•°æ®åº“æ–°å»º `User` è¡¨ï¼ŒåŒ…å« `id (uuid)`, `clerk_id`, `feishu_id` å­—æ®µã€‚
*   **æ“ä½œ**: ä¸šåŠ¡é€»è¾‘å…¨éƒ¨åŸºäºå†…éƒ¨ `uuid`ã€‚ç™»å½•æ—¶åŠ¨æ€æŸ¥æ‰¾å¯¹åº”çš„ `uuid`ã€‚

å»ºè®®ç°é˜¶æ®µé‡‡ç”¨ **æ–¹æ¡ˆ A**ã€‚

### 3.7 å®æ–½å»ºè®®
åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `web/` æ–‡ä»¶å¤¹ï¼Œç¼–å†™çº¯ HTML é¡µé¢ã€‚é€šè¿‡ GitHub Pages å‘å¸ƒï¼Œå‰ç«¯é›¶èµ„æºæ¶ˆè€—ã€‚

---
## 4. ä¸‹ä¸€æ­¥è¡ŒåŠ¨ (Next Steps)
1.  **Web App (å½“å‰ä¼˜å…ˆ)**:
    *   åˆ›å»º `web/` ç›®å½•ç»“æ„å’ŒåŸºç¡€ HTML é¡µé¢ã€‚
    *   é›†æˆ Clerk ç™»å½•ã€‚
    *   å®ç° File Upload -> API Call -> Render Result é“¾è·¯ã€‚
    *   é…ç½® GitHub Pages éƒ¨ç½²ã€‚
2.  **Feishu Integrations**:
    *   æ›´æ–° `message_router` æ”¯æŒ Title æ­£åˆ™è·¯ç”±ã€‚
    *   æ–°å»º `keep_analysis_card.py` å’Œ `diet_analysis_card.py` (Interactive Version)ã€‚
    *   åœ¨ `message_handler` ä¸­å®ç° `handle_keep_analyze_async`ã€‚
3.  **Backend Support**:
    *   æ·»åŠ  CORS é…ç½®å…è®¸ GitHub Pages åŸŸåã€‚
    *   å‡†å¤‡ Clerk JWT éªŒè¯çš„ FastAPI Dependencyã€‚

## 5. è¡¥å……å‚è€ƒ (Implementation Details)

### 2.5 ç¼“å­˜ç­–ç•¥è¡¥å…… (Smart Caching)
*æ¥æºï¼šdiet_bot_specs_v2.md*

ä¸ºäº†èŠ‚çœ Token å¹¶å®ç°ç§’çº§å“åº”ï¼Œå»ºè®®åŒºåˆ† **ä¸Šä¸‹æ–‡ç¼“å­˜** ä¸ **ç»“æœç¼“å­˜**ï¼š

1.  **Input Hash è®¡ç®—**:
    *   é’ˆå¯¹å»ºè®®ç”Ÿæˆï¼ŒInput æ˜¯ `Food List + Weights`.
    *   `hash_key = md5(f"{date}|{meal_type}|sorted([{food_name}:{weight},...])")`
2.  **Advice Cache**:
    *   å­˜å‚¨: `Redis Key: advice:{hash_key} -> "å»ºè®®æ–‡æœ¬..."`
    *   **å›é€€ä¼˜åŒ– (Revert Scenario)**: ç”¨æˆ·å¦‚æœæŠŠ "40g" æ”¹æˆ "50g" (è§¦å‘æ–°ç”Ÿæˆ)ï¼Œåˆæ”¹å› "40g"ï¼Œè®¡ç®—å‡ºçš„ hash_key ç›¸åŒï¼Œåº”ç›´æ¥å‘½ä¸­ç¼“å­˜ï¼Œæ— éœ€å†æ¬¡è°ƒç”¨ LLMã€‚
3.  **ç”Ÿå‘½å‘¨æœŸ**:
    *   å»ºè®®ç¼“å­˜æœ‰æ•ˆæœŸå¯è®¾ä¸º 24å°æ—¶ (è·¨å¡ç‰‡å¤ç”¨)ã€‚
    *   å¡ç‰‡ä¸Šä¸‹æ–‡ (`message_id` ç»‘å®š) éšå¡ç‰‡ç”Ÿå‘½å‘¨æœŸç»“æŸï¼ˆå¦‚ 1 å°æ—¶åæˆ–å½’æ¡£åï¼‰æ¸…ç†ã€‚

---

## 6. å‘¨åˆ†æåŠŸèƒ½ (Weekly Analysis) - Diet & Keep

### 6.1 åŠŸèƒ½æ¦‚è¿°
ä¸º Diet å’Œ Keep æ¨¡å—æä¾›å‘¨ç»´åº¦çš„ç»¼åˆåˆ†æèƒ½åŠ›ï¼ŒåŒ…æ‹¬ï¼š
- é¤é£Ÿè´¨é‡åˆ†æä¸è¯„åˆ†
- ä¸‹å‘¨é¤é£Ÿå»ºè®®
- çƒ­é‡æ ¡å‡†ç³»æ•°ä¼°ç®—
- ç›®æ ‡è¿›åº¦å¯¹æ¯”
- å›´åº¦å˜åŒ–åˆ†æ
- å¯è§†åŒ–è¶‹åŠ¿å›¾è¡¨

### 6.2 ç›®å½•ç»“æ„
ä¿æŒä¸ `diet`/`keep` ä¸€è‡´çš„æ‰å¹³ç»“æ„ï¼š
```
apps/weekly_analysis/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ api.py                  # FastAPI ç«¯ç‚¹
â”œâ”€â”€ data_collector.py       # å‘¨æ•°æ®é‡‡é›†
â”œâ”€â”€ analysis_schema.py      # Pydantic Schema (AIè¾“å‡ºç»“æ„)
â”œâ”€â”€ weekly_prompt.py        # AI åˆ†æ Prompt
â”œâ”€â”€ calorie_math.py         # çƒ­é‡æ ¡å‡†æ•°å­¦è®¡ç®—ï¼ˆéAIï¼‰
â”œâ”€â”€ chart_config.py         # ECharts é…ç½®ç”Ÿæˆ
â””â”€â”€ usecases/
    â””â”€â”€ weekly_analysis_usecase.py  # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
```

### 6.3 MVP æ‹†åˆ†ä¸è¿›åº¦

#### MVP1ï¼šæ•°æ®é‡‡é›† + åŸºç¡€APIéª¨æ¶ âœ… ä»£ç å®Œæˆï¼Œå¾…éªŒè¯
- [x] åˆ›å»º `apps/weekly_analysis/` ç›®å½•
- [x] `data_collector.py`: é‡‡é›†æŒ‡å®šå‘¨çš„ diet/keep æ•°æ®
  - `WeeklyDataBundle` æ•°æ®ç±»å«è®¡ç®—å±æ€§åˆ¤æ–­åˆ†æè§¦å‘æ¡ä»¶
  - å¤ç”¨ `RecordService` çš„å·²æœ‰æ–¹æ³•
- [x] `api.py`: åŸºç¡€ç«¯ç‚¹ `/api/weekly-analysis/data`
  - æ”¯æŒ `week_offset` å‚æ•°ï¼ˆ-1=ä¸Šå‘¨, 0=æœ¬å‘¨ï¼‰
  - æ”¯æŒç›´æ¥æŒ‡å®š `week_start` æ—¥æœŸ
- [x] æ³¨å†Œåˆ° `apps/app.py`
- [ ] éªŒè¯æ•°æ®é‡‡é›†æ­£ç¡®æ€§ï¼ˆéœ€å¯åŠ¨åç«¯æœåŠ¡æµ‹è¯•ï¼‰

#### MVP2ï¼šAIç»¼åˆåˆ†æ âœ… ä»£ç å®Œæˆ
- [x] `analysis_schema.py`: å®šä¹‰ AI è¾“å‡ºçš„ Pydantic Schema
  - `WeeklyAnalysisResult` ä¸»æ¨¡å‹ï¼ŒåŒ…å«å¯é€‰çš„å­åˆ†ææ¨¡å—
  - `WeeklyDietAnalysis`, `MealSuggestion`, `CalorieCalibration`, `GoalProgress`, `DimensionChange`
- [x] `weekly_prompt.py`: æ„å»ºç»¼åˆåˆ†æ Prompt
  - åŠ¨æ€æ ¼å¼åŒ–æ•°æ®ã€æ ¹æ®å¯ç”¨æ€§ç”Ÿæˆæ¡ä»¶æŒ‡ä»¤
- [x] `usecases/weekly_analysis_usecase.py`: è°ƒç”¨ AI ç”Ÿæˆåˆ†æ
  - æ”¯æŒç»“æ„åŒ–JSON (`execute_async`) å’Œçº¯æ–‡æœ¬ (`execute_text_async`) ä¸¤ç§è¾“å‡º
- [x] API ç«¯ç‚¹ `/api/weekly-analysis/report` å®Œå–„
  - æ”¯æŒ `output_mode=json|text`
  - é›†æˆå¹¶å‘æ§åˆ¶å’Œé™æµ

#### MVP3ï¼šçƒ­é‡æ ¡å‡† + å›¾è¡¨
- [ ] `calorie_math.py`: å·®å€¼æ³•çƒ­é‡æ ¡å‡†è®¡ç®—
- [ ] `chart_config.py`: ç”Ÿæˆ ECharts é…ç½® JSON
- [ ] åœ¨ report ä¸­æ•´åˆå›¾è¡¨æ•°æ®

#### MVP4ï¼šWeb å‰ç«¯é›†æˆ
- [ ] å·¦ä¾§èœå•æ·»åŠ "ğŸ“… å‘¨æŠ¥"å…¥å£
- [ ] å‘¨æŠ¥å±•ç¤ºé¡µé¢ï¼ˆå« ECharts å›¾è¡¨ï¼‰
- [ ] äº¤äº’è°ƒæ•´ï¼ˆå‘¨åˆ‡æ¢ç­‰ï¼‰

#### MVP5ï¼šé£ä¹¦é›†æˆ
- [ ] åœ¨ç°æœ‰å‘¨æŠ¥æµç¨‹ (`routine_daily_element.py`) ä¸­è¿½åŠ é¥®é£Ÿå¥åº·åˆ†æç« èŠ‚
- [ ] é£ä¹¦äº‘æ–‡æ¡£å†…å®¹ç”Ÿæˆ

### 6.4 æ•°æ®æºä¸æ¡ä»¶

| æ•°æ® | æ¥æº | é‡‡é›†é€»è¾‘ |
|-----|------|---------|
| Diet Records | `ledger_{date}.jsonl` | å‘¨åŒºé—´å†…æ‰€æœ‰æ–‡ä»¶ |
| Dish Library | `dish_library.jsonl` | å–æœ€æ–°100æ¡ |
| Scale Records | `scale_{yyyy_mm}.jsonl` | å‘¨åŒºé—´å†…çš„è®°å½• |
| Sleep Records | `sleep_{yyyy_mm}.jsonl` | å‘¨åŒºé—´å†…çš„è®°å½• |
| Dimensions | `dimensions_{yyyy_mm}.jsonl` | å‘¨å†… + baseline(å‘¨å‰æœ€åä¸€æ¡) |
| Profile | `profile.json` | ç”¨æˆ·ç›®æ ‡é…ç½® |
| Preferences | `preferences.json` | ğŸ†• ä¸ªæ€§åŒ–é¥®é£Ÿåå¥½ |

### 6.5 åˆ†æè§¦å‘æ¡ä»¶

| åˆ†æé¡¹ | è§¦å‘æ¡ä»¶ |
|-------|---------|
| é¤é£Ÿè´¨é‡åˆ†æ | `len(diet_records) > 0` |
| ä¸‹å‘¨é¤é£Ÿå»ºè®® | `len(diet_records) > 0 and len(dish_library) > 0` |
| çƒ­é‡æ ¡å‡† | `len(diet_records) >= 3 and len(scale_records) >= 2` |
| ç›®æ ‡è¿›åº¦ | `profile is not None` |
| å›´åº¦åˆ†æ | è‡³å°‘2ä¸ªä¸åŒæ—¥æœŸçš„å›´åº¦æ•°æ® |

### 6.6 ä¸ªæ€§åŒ–åå¥½é…ç½®
æ–°å¢ `user_data/<user_id>/diet/preferences.json`:
```json
{
  "fixed_meals": {
    "breakfast": "ç‡•éº¦è„±è„‚ç‰›å¥¶+æ°´æœï¼ˆä¸å»ºè®®æ›¿æ¢ï¼‰"
  },
  "dietary_restrictions": ["å°½é‡å°‘å¤–é£Ÿ", "å‘¨æœ«å…è®¸æ”¾æ¾"],
  "notes": "ä¼˜å…ˆä¿è¯è›‹ç™½è´¨æ‘„å…¥"
}
```

---

## 3.10 è¥å…»æ‘„å…¥å¯è§†åŒ–ä¸äº¤äº’ä¼˜åŒ– (FEAT-001 + FEAT-004)

### 3.10.1 FEAT-001ï¼šè¥å…»æ‘„å…¥å¯è§†åŒ–å›¾è¡¨

#### æ ¸å¿ƒç›®æ ‡
åˆ›å»ºä¸€ä¸ª**å¯äº¤äº’çš„å¤šå±‚æŸ±çŠ¶/æ¡å½¢å›¾è¡¨**ï¼Œæ¸…æ™°å±•ç¤ºä¸‰å±‚è¥å…»æ•°æ®çš„å¯¹æ¯”å…³ç³»ï¼š
1. **æœ¬æ¬¡åˆ†æå€¼** (This Meal)ï¼šå½“å‰æ­£åœ¨ç¼–è¾‘çš„èœå¼æ±‡æ€»ï¼Œä¸ checkbox çŠ¶æ€**å®æ—¶è”åŠ¨**
2. **ä»Šæ—¥å·²æ‘„å…¥** (Today's Intake)ï¼šä»Šå¤©å·²ä¿å­˜çš„æ‰€æœ‰é¥®é£Ÿè®°å½•æ±‡æ€»ï¼ˆä¸å«æœ¬æ¬¡æœªä¿å­˜çš„ï¼‰
3. **æ¯æ—¥ç›®æ ‡å€¼** (Daily Target)ï¼šæ¥è‡ª `profile.diet` çš„ç›®æ ‡é…ç½®ï¼ˆå¦‚æœæœ‰ï¼‰

#### å¯è§†åŒ–æ–¹æ¡ˆï¼šECharts å †å æŸ±çŠ¶å›¾

```
          èƒ½é‡      è›‹ç™½è´¨      è„‚è‚ª       ç¢³æ°´       çº¤ç»´        é’ 
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 100%â”‚   â–“â–“    â”‚  â–ˆâ–ˆâ–ˆ    â”‚   â–ˆâ–ˆ    â”‚   â–ˆâ–ˆ    â”‚    â–ˆ    â”‚  â–ˆâ–ˆâ–ˆâ–ˆ   â”‚ â† ç›®æ ‡çº¿
     â”‚   â–“â–“    â”‚  â–ˆâ–ˆâ–ˆ    â”‚ â–‘â–‘â–ˆâ–ˆ    â”‚ â–‘â–‘â–ˆâ–ˆ    â”‚  â–‘â–‘â–ˆ    â”‚ â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆ  â”‚
  50%â”‚ â–‘â–‘â–“â–“    â”‚â–‘â–‘â–‘â–ˆâ–ˆâ–ˆ   â”‚ â–‘â–‘â–ˆâ–ˆ    â”‚ â–‘â–‘â–ˆâ–ˆ    â”‚  â–‘â–‘â–ˆ    â”‚ â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆ  â”‚
     â”‚ â–‘â–‘â–“â–“    â”‚â–‘â–‘â–‘â–ˆâ–ˆâ–ˆ   â”‚ â–‘â–‘â–ˆâ–ˆ    â”‚ â–‘â–‘â–ˆâ–ˆ    â”‚  â–‘â–‘â–ˆ    â”‚ â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆ  â”‚
   0%â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     â–“â–“ = æœ¬æ¬¡åˆ†æ (This Meal)    â–‘â–‘ = ä»Šæ—¥å·²æ‘„å…¥ (Today's Intake)
     â”€â”€ = ç›®æ ‡çº¿ (Daily Target)
```

#### æ•°æ®è”åŠ¨è§„åˆ™

| äº¤äº’è¡Œä¸º | å›¾è¡¨å“åº” |
|----------|----------|
| å‹¾é€‰/å–æ¶ˆå‹¾é€‰æŸä¸ªèœå¼ | é‡æ–°è®¡ç®— `currentDietTotals`ï¼Œå®æ—¶æ›´æ–°"æœ¬æ¬¡åˆ†æ"æŸ± |
| ç¼–è¾‘èœå¼çš„è¥å…»æ•°å€¼ | é‡æ–°è®¡ç®— `currentDietTotals`ï¼Œå®æ—¶æ›´æ–°"æœ¬æ¬¡åˆ†æ"æŸ± |
| åˆ‡æ¢ Ingredient æ¯”ä¾‹æ¨¡å¼ | é‡æ–°è®¡ç®— Dish Totalsï¼Œè”åŠ¨æ›´æ–° |
| ä¿å­˜è®°å½•æˆåŠŸ | "ä»Šæ—¥å·²æ‘„å…¥" æŸ±æ›´æ–°ï¼ˆéœ€é‡æ–°è·å–ä»Šæ—¥æ±‡æ€»ï¼‰ |

#### å›¾ä¾‹äº¤äº’

å›¾è¡¨å›¾ä¾‹ (Legend) æ”¯æŒ**ç‹¬ç«‹ç‚¹å‡»åˆ‡æ¢æ˜¾ç¤º/éšè—**ï¼š
- ç‚¹å‡» `æœ¬æ¬¡åˆ†æ` â†’ éšè—/æ˜¾ç¤ºè¯¥ç³»åˆ—çš„æŸ±å­
- ç‚¹å‡» `ä»Šæ—¥å·²æ‘„å…¥` â†’ éšè—/æ˜¾ç¤ºè¯¥ç³»åˆ—çš„æŸ±å­
- ç‚¹å‡» `æ¯æ—¥ç›®æ ‡` â†’ éšè—/æ˜¾ç¤ºç›®æ ‡çº¿ï¼ˆmarkLineï¼‰

#### æŠ€æœ¯å®ç°

**1. æ–°å¢ APIï¼šè·å–ä»Šæ—¥å·²æ‘„å…¥æ±‡æ€»**

```python
# apps/diet/api.py
@router.get("/diet/today-summary")
async def get_today_summary(user_id: str = Depends(require_user)):
    """è·å–ä»Šæ—¥å·²ä¿å­˜çš„é¥®é£Ÿè®°å½•æ±‡æ€»"""
    records = record_service.get_diet_records_for_date(user_id, date.today())
    summary = {
        "total_energy_kcal": 0,
        "total_protein_g": 0,
        "total_fat_g": 0,
        "total_carb_g": 0,
        "total_fiber_g": 0,
        "total_sodium_mg": 0,
        "record_count": len(records)
    }
    for r in records:
        for dish in r.get("dishes", []):
            if dish.get("enabled", True):
                # ç´¯åŠ è¥å…»ç´ ï¼ˆé€»è¾‘å¤ç”¨ RecordServiceï¼‰
                ...
    return summary
```

**2. å‰ç«¯æ¨¡å—ï¼š`modules/nutrition-chart.js`**

```javascript
const NutritionChartModule = {
    chartInstance: null,
    todaySummary: null,  // ç¼“å­˜ä»Šæ—¥å·²æ‘„å…¥

    async init(container) {
        // è·å–ä»Šæ—¥å·²æ‘„å…¥
        this.todaySummary = await API.get('/diet/today-summary');
        this.render(container);
    },

    render(container) {
        if (typeof echarts === 'undefined') return;

        const chart = echarts.init(container);
        const option = this.buildOption();
        chart.setOption(option);
        this.chartInstance = chart;

        // ç›‘å¬å›¾ä¾‹ç‚¹å‡»
        chart.on('legendselectchanged', (params) => {
            console.log('Legend changed:', params.selected);
        });
    },

    // å¤–éƒ¨è°ƒç”¨ï¼šå½“ checkbox æˆ–æ•°å€¼å˜åŒ–æ—¶æ›´æ–°
    updateCurrentMeal(totals) {
        if (!this.chartInstance) return;
        this.chartInstance.setOption({
            series: [{ id: 'this-meal', data: this.toDataArray(totals) }]
        });
    },

    buildOption() {
        const targets = Dashboard.profile?.diet || {};
        const current = Dashboard.currentDietTotals || {};
        const today = this.todaySummary || {};

        // ... å®Œæ•´ ECharts é…ç½®
    }
};
```

**3. CSS æ ·å¼**

```css
.nutrition-chart-container {
    margin: var(--spacing-md) 0;
    padding: var(--spacing-md);
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    min-height: 200px;
}

.nutrition-chart-wrapper {
    width: 100%;
    height: 220px;
}

.nutrition-chart-legend {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-top: 10px;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    font-size: 0.75rem;
    color: var(--color-text-secondary);
}

.legend-item.disabled {
    opacity: 0.4;
    text-decoration: line-through;
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
}
```

**4. é¢œè‰²å®šä¹‰**

| ç³»åˆ— | é¢œè‰² | è¯´æ˜ |
|------|------|------|
| æœ¬æ¬¡åˆ†æ | `#6366f1` (Indigo) | å“ç‰Œä¸»è‰²ï¼Œè¡¨ç¤ºå½“å‰æ“ä½œ |
| ä»Šæ—¥å·²æ‘„å…¥ | `#22c55e` (Green) | å·²å®Œæˆ/å·²ä¿å­˜çš„æ„ä¹‰ |
| æ¯æ—¥ç›®æ ‡ | `rgba(255,255,255,0.3)` è™šçº¿ | ä½œä¸ºå‚è€ƒçº¿ï¼Œä¸åº”æŠ¢å è§†è§‰ |

#### å¸ƒå±€ä½ç½®

å›¾è¡¨ä½äº**è¥å…»æ±‡æ€»åŒºåŸŸ (`.nutrition-summary`) ä¸‹æ–¹ã€AI è¥å…»ç‚¹è¯„ä¸Šæ–¹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ½ï¸ é¥®é£Ÿè®°å½•  Â·  3 ç§é£Ÿç‰© Â· åˆé¤     â”‚  â† Header
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ 188 kcal   â”‚  â”‚P 3gâ”‚F 4gâ”‚C 42â”‚    â”‚  â† è¥å…»æ±‡æ€» (åªè¯»)
â”‚  â”‚ æ€»èƒ½é‡     â”‚  â”‚çº¤ç»´â”‚é’   â”‚é‡é‡â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“Š è¥å…»è¿›åº¦                          â”‚  â† FEAT-001: å›¾è¡¨åŒºåŸŸ
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘   [æŸ±çŠ¶å›¾]                      â•‘  â”‚
â”‚  â•‘   èƒ½é‡  è›‹ç™½  è„‚è‚ª  ç¢³æ°´  ...    â•‘  â”‚
â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£  â”‚
â”‚  â•‘ â— æœ¬æ¬¡  â— ä»Šæ—¥  â”€ â”€ ç›®æ ‡        â•‘  â”‚  â† å¯äº¤äº’å›¾ä¾‹
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ’¡ AI è¥å…»ç‚¹è¯„  [â–¼]                  â”‚  â† FEAT-004: å¯æŠ˜å 
â”‚  ï¼ˆç‚¹è¯„å†…å®¹...ï¼‰                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é£Ÿç‰©æ˜ç»†                             â”‚
â”‚  ...                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3.10.2 FEAT-004ï¼šè¥å…»ç‚¹è¯„åŒºåŸŸå¯æŠ˜å 

#### éœ€æ±‚èƒŒæ™¯
è¥å…»ç‚¹è¯„æ–‡å­—é€šå¸¸è¾ƒé•¿ï¼Œå æ®è¾ƒå¤šå‚ç›´ç©ºé—´ï¼Œåœ¨ç”¨æˆ·éœ€è¦ä¸“æ³¨ç¼–è¾‘ä¸‹æ–¹"é£Ÿç‰©æ˜ç»†"æ•°å€¼æ—¶ï¼Œä¼šé€ æˆæ»šåŠ¨è·ç¦»å¢åŠ ã€‚æä¾›æŠ˜å åŠŸèƒ½å¯ä»¥è®©ç”¨æˆ·åœ¨éœ€è¦æ—¶éšè—ç‚¹è¯„å†…å®¹ï¼Œæ–¹ä¾¿æ“ä½œã€‚

#### äº¤äº’è®¾è®¡

| çŠ¶æ€ | æ˜¾ç¤ºå†…å®¹ | è§¦å‘æ–¹å¼ |
|------|----------|----------|
| **å±•å¼€ (é»˜è®¤)** | æ ‡é¢˜ + æŠ˜å å›¾æ ‡ `â–¼` + å®Œæ•´ç‚¹è¯„å†…å®¹ | é¡µé¢åˆå§‹åŠ è½½ |
| **æŠ˜å ** | ä»…æ ‡é¢˜ + å±•å¼€å›¾æ ‡ `â–¶` | ç‚¹å‡»æ ‡é¢˜åŒºåŸŸ |

```
å±•å¼€çŠ¶æ€:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¡ AI è¥å…»ç‚¹è¯„                   â–¼  â”‚  â† ç‚¹å‡»ä»»æ„ä½ç½®å¯æŠ˜å 
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä½ å¥½ï¼æ ¹æ®ä½ çš„è¥å…»æ‘„å…¥æƒ…å†µï¼Œ...      â”‚
â”‚ 1. é¤é£Ÿæ€»ç»“...                       â”‚
â”‚ 2. ä»Šæ—¥è¿›å±•åˆ†æ...                   â”‚
â”‚ 3. åç»­å»ºè®®...                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æŠ˜å çŠ¶æ€:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¡ AI è¥å…»ç‚¹è¯„                   â–¶  â”‚  â† ç‚¹å‡»å±•å¼€
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### HTML ç»“æ„å˜æ›´

```html
<!-- Before (current) -->
<div id="advice-section" class="advice-section">
  <div class="advice-header">
    <div class="dishes-title">ğŸ’¡ AI è¥å…»ç‚¹è¯„</div>
    <span id="advice-status" class="advice-status"></span>
  </div>
  <div id="advice-content" class="advice-content">...</div>
</div>

<!-- After (with collapse) -->
<div id="advice-section" class="advice-section">
  <div class="advice-header collapsible" onclick="Dashboard.toggleAdviceSection()">
    <div class="dishes-title">ğŸ’¡ AI è¥å…»ç‚¹è¯„</div>
    <div class="advice-header-right">
      <span id="advice-status" class="advice-status"></span>
      <span class="advice-toggle-icon" id="advice-toggle-icon">â–¼</span>
    </div>
  </div>
  <div id="advice-content" class="advice-content">...</div>  <!-- å¯æ·»åŠ  .collapsed -->
</div>
```

#### CSS æ ·å¼

```css
.advice-header.collapsible {
    cursor: pointer;
    user-select: none;
}

.advice-header.collapsible:hover {
    background: rgba(255, 255, 255, 0.03);
}

.advice-header-right {
    display: flex;
    align-items: center;
    gap: 8px;
}

.advice-toggle-icon {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    transition: transform 0.2s ease;
}

.advice-section.collapsed .advice-toggle-icon {
    transform: rotate(-90deg);
}

.advice-content {
    transition: max-height 0.3s ease, opacity 0.2s ease, padding 0.3s ease;
    overflow: hidden;
}

.advice-section.collapsed .advice-content {
    max-height: 0;
    opacity: 0;
    padding-top: 0;
    padding-bottom: 0;
}
```

#### JavaScript æ–¹æ³•

```javascript
// diet-render.js æˆ– dashboard.js
toggleAdviceSection() {
    const section = document.getElementById('advice-section');
    if (!section) return;

    section.classList.toggle('collapsed');

    // ä¿å­˜æŠ˜å çŠ¶æ€åˆ° sessionStorageï¼ˆåŒä¼šè¯ä¿æŒï¼‰
    const isCollapsed = section.classList.contains('collapsed');
    sessionStorage.setItem('dk_advice_collapsed', isCollapsed ? '1' : '0');
},

// åœ¨ renderDietResult ä¸­æ¢å¤çŠ¶æ€
restoreAdviceState() {
    const collapsed = sessionStorage.getItem('dk_advice_collapsed') === '1';
    if (collapsed) {
        document.getElementById('advice-section')?.classList.add('collapsed');
    }
}
```

---

### 3.10.3 å®æ–½è®¡åˆ’

| é˜¶æ®µ | ä»»åŠ¡ | æ¶‰åŠæ–‡ä»¶ | ä¼˜å…ˆçº§ |
|------|------|----------|--------|
| 1 | æ–°å¢ `/diet/today-summary` API | `apps/diet/api.py`, `record_service.py` | é«˜ |
| 2 | åˆ›å»º `nutrition-chart.js` æ¨¡å— | `web/js/modules/nutrition-chart.js` | é«˜ |
| 3 | ä¿®æ”¹ `diet-render.js` æ¸²æŸ“å›¾è¡¨å®¹å™¨ | `web/js/modules/diet-render.js` | é«˜ |
| 4 | æ·»åŠ å›¾è¡¨ CSS æ ·å¼ | `web/css/dashboard.css` | é«˜ |
| 5 | å®ç° checkbox/æ•°å€¼ â†’ å›¾è¡¨è”åŠ¨ | `diet-edit.js`, `nutrition-chart.js` | é«˜ |
| 6 | å®ç°è¥å…»ç‚¹è¯„æŠ˜å  (FEAT-004) | `diet-render.js`, `dashboard.css` | ä¸­ |
| 7 | ç§»åŠ¨ç«¯é€‚é…ï¼ˆå›¾è¡¨é«˜åº¦ã€è§¦æ§ï¼‰ | `dashboard.css` | ä¸­ |

---

### 3.10.4 ç§»åŠ¨ç«¯é€‚é…

- å›¾è¡¨é«˜åº¦é€‚å½“ç¼©å‡ï¼ˆ180px â†’ 150pxï¼‰
- å›¾ä¾‹æ”¹ä¸ºæ¨ªå‘æ»šåŠ¨æˆ–æ¢è¡Œ
- ç‚¹å‡»å›¾ä¾‹åŒºåŸŸåŠ å¤§ï¼ˆä¾¿äºè§¦æ§ï¼‰
- è¥å…»ç‚¹è¯„é»˜è®¤æŠ˜å ï¼ˆç§»åŠ¨ç«¯ç©ºé—´æœ‰é™ï¼‰